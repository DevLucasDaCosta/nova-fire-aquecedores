# GUIA COMPLETO DE DEPLOY - NOVA FIRE AQUECEDORES
# Servidor Debian + Node.js + PM2 + Nginx + SSL
# Data: 14 de Agosto de 2025

===============================================================================
üìã PR√â-REQUISITOS
===============================================================================

‚úÖ Servidor Debian funcionando
‚úÖ Acesso root/sudo ao servidor
‚úÖ Dom√≠nio configurado (novafireaquecedores.com.br)
‚úÖ DNS apontando para IP do servidor (72.60.14.60)

===============================================================================
üöÄ PASSO A PASSO COMPLETO
===============================================================================

=================== PASSO 1: VERIFICAR/INSTALAR GIT =========================

# Verificar se git est√° instalado
git --version

# Se n√£o estiver instalado ou der erro:
sudo apt update
sudo apt install -y git

=================== PASSO 2: VERIFICAR/INSTALAR NODE.JS ====================

# Verificar se Node.js est√° instalado
node --version
npm --version

# Se n√£o estiver instalado ou a vers√£o for muito antiga (precisa ser 18+):
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# Verificar instala√ß√£o
node --version
npm --version

=================== PASSO 3: VERIFICAR/INSTALAR PM2 ========================

# Verificar se PM2 est√° instalado
pm2 --version

# Se n√£o estiver instalado:
sudo npm install -g pm2

# Verificar instala√ß√£o
pm2 --version

=================== PASSO 4: VERIFICAR/INSTALAR NGINX ======================

# Verificar se Nginx est√° instalado
nginx -v

# Se n√£o estiver instalado:
sudo apt install -y nginx

# Iniciar e habilitar Nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# Verificar status
sudo systemctl status nginx

# Se der erro de porta ocupada (Apache):
sudo systemctl stop apache2
sudo systemctl disable apache2
sudo systemctl start nginx

=================== PASSO 5: VERIFICAR/INSTALAR CERTBOT ====================

# Verificar se Certbot est√° instalado
certbot --version

# Se n√£o estiver instalado:
sudo apt install -y certbot python3-certbot-nginx

=================== PASSO 6: CRIAR ESTRUTURA DE DIRET√ìRIOS ==================

# Criar diret√≥rio para aplica√ß√µes web
sudo mkdir -p /var/www

# Verificar se usu√°rio www-data existe
id www-data

# Se n√£o existir:
sudo useradd -r -s /bin/false www-data

# Configurar permiss√µes
sudo chown -R www-data:www-data /var/www
sudo chmod -R 755 /var/www

# Criar diret√≥rio para logs do PM2
sudo mkdir -p /var/log/pm2
sudo chown -R www-data:www-data /var/log/pm2

=================== PASSO 7: CLONAR O PROJETO DO GITHUB ==================

# Ir para o diret√≥rio web
cd /var/www

# Clonar seu projeto
sudo git clone https://github.com/DevLucasDaCosta/nova-fire-aquecedores.git

# Entrar no diret√≥rio do projeto
cd nova-fire-aquecedores

# Configurar permiss√µes
sudo chown -R www-data:www-data /var/www/nova-fire-aquecedores

=================== PASSO 8: INSTALAR DEPEND√äNCIAS DO PROJETO ==============

# Entrar no diret√≥rio do projeto
cd /var/www/nova-fire-aquecedores

# Instalar depend√™ncias como usu√°rio www-data
sudo -u www-data npm ci

# Verificar se instalou corretamente
sudo -u www-data npm list --depth=0

=================== PASSO 9: FAZER BUILD DO PROJETO ========================

# Ainda no diret√≥rio do projeto
cd /var/www/nova-fire-aquecedores

# Fazer build como usu√°rio www-data
sudo -u www-data npm run build

# Verificar se o build foi criado
ls -la .next/

=================== PASSO 10: CRIAR CONFIGURA√á√ÉO DO PM2 ====================

# Criar arquivo de configura√ß√£o do PM2
sudo nano /var/www/nova-fire-aquecedores/ecosystem.config.js

# Cole o seguinte conte√∫do:
module.exports = {
  apps: [
    {
      name: 'nova-fire-aquecedores',
      script: 'npm',
      args: 'start',
      cwd: '/var/www/nova-fire-aquecedores',
      instances: 'max',
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: '3001'
      },
      error_file: '/var/log/pm2/nova-fire-aquecedores-error.log',
      out_file: '/var/log/pm2/nova-fire-aquecedores-out.log',
      log_file: '/var/log/pm2/nova-fire-aquecedores.log',
      time: true,
      max_memory_restart: '500M',
      node_args: '--max-old-space-size=400',
      restart_delay: 4000,
      max_restarts: 5,
      min_uptime: '10s'
    }
  ]
};

# Salvar e sair (Ctrl+X, Y, Enter)

=================== PASSO 11: INICIAR APLICA√á√ÉO COM PM2 =====================

# Entrar no diret√≥rio do projeto
cd /var/www/nova-fire-aquecedores

# Iniciar aplica√ß√£o como usu√°rio www-data
sudo -u www-data pm2 start ecosystem.config.js

# Verificar se est√° rodando
sudo -u www-data pm2 list

# Ver logs (opcional)
sudo -u www-data pm2 logs nova-fire-aquecedores

=================== PASSO 12: CONFIGURAR STARTUP AUTOM√ÅTICO DO PM2 ==========

# Configurar PM2 para iniciar automaticamente
sudo -u www-data pm2 startup systemd -u www-data --hp /var/www

# IMPORTANTE: O comando acima vai retornar uma linha que voc√™ deve executar
# Algo como: sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u www-data --hp /var/www
# EXECUTE A LINHA QUE FOR RETORNADA

# Salvar configura√ß√£o atual do PM2
sudo -u www-data pm2 save

=================== PASSO 13: TESTAR A APLICA√á√ÉO ============================

# Testar se a aplica√ß√£o est√° respondendo
curl http://localhost:3001

# Verificar se a porta est√° sendo usada
sudo netstat -tlnp | grep :3001

=================== PASSO 14: CONFIGURAR NGINX ==============================

# Criar arquivo de configura√ß√£o do Nginx
sudo nano /etc/nginx/sites-available/nova-fire-aquecedores

# Cole o seguinte conte√∫do (SUBSTITUA novafireaquecedores.com.br pelo seu dom√≠nio):

# Configura√ß√£o tempor√°ria sem SSL (ser√° configurado depois)
server {
    listen 80;
    server_name novafireaquecedores.com.br www.novafireaquecedores.com.br;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json
        application/xml
        image/svg+xml;

    # Main application
    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Static files optimization
    location /_next/static {
        proxy_pass http://127.0.0.1:3001;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Images and assets
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|css|js|woff|woff2|ttf|eot)$ {
        proxy_pass http://127.0.0.1:3001;
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # Block access to sensitive files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# Salvar e sair (Ctrl+X, Y, Enter)

=================== PASSO 15: ATIVAR SITE NO NGINX ===========================

# Criar link simb√≥lico para ativar o site
sudo ln -s /etc/nginx/sites-available/nova-fire-aquecedores /etc/nginx/sites-enabled/

# Remover site padr√£o do Nginx (opcional)
sudo rm -f /etc/nginx/sites-enabled/default

# Testar configura√ß√£o do Nginx
sudo nginx -t

# Se deu tudo certo, recarregar Nginx
sudo systemctl reload nginx

=================== PASSO 16: CONFIGURAR DNS (NO PROVEDOR) ==================

# Configure no seu provedor de dom√≠nio:
# Tipo: A
# Nome: @
# Valor: 72.60.14.60
# TTL: 3600

# Tipo: CNAME (se j√° n√£o existir)
# Nome: www
# Valor: novafireaquecedores.com.br
# TTL: 3600

# Aguarde a propaga√ß√£o do DNS (pode levar at√© 24h, mas geralmente √© mais r√°pido)

=================== PASSO 17: TESTAR SITE SEM SSL ===========================

# Verificar se o site est√° acess√≠vel
curl -I http://novafireaquecedores.com.br

# Verificar logs do Nginx
sudo tail -f /var/log/nginx/access.log

=================== PASSO 18: CONFIGURAR SSL COM LET'S ENCRYPT ==============

# Obter certificado SSL
sudo certbot --nginx -d novafireaquecedores.com.br -d www.novafireaquecedores.com.br

# O Certbot vai perguntar algumas coisas:
# 1. Email: coloque seu email
# 2. Aceitar termos: Y
# 3. Compartilhar email: A (Accept) ou N (No)
# 4. Redirect HTTP para HTTPS: 2 (Redirect)

=================== PASSO 19: VERIFICAR SSL E SITE FINAL =====================

# Testar certificado SSL
sudo certbot certificates

# Verificar renova√ß√£o autom√°tica
sudo certbot renew --dry-run

# Configurar renova√ß√£o autom√°tica no cron (se n√£o estiver)
(crontab -l 2>/dev/null; echo "0 12 * * * /usr/bin/certbot renew --quiet") | crontab -

=================== PASSO 20: VERIFICA√á√ïES FINAIS ===========================

# Verificar status de todos os servi√ßos
sudo systemctl status nginx
sudo -u www-data pm2 list
sudo -u www-data pm2 logs nova-fire-aquecedores --lines 5

# Testar site completo
curl -I https://novafireaquecedores.com.br

# Verificar portas
sudo netstat -tlnp | grep -E ':(80|443|3001)'

===============================================================================
üîß COMANDOS √öTEIS PARA MANUTEN√á√ÉO
===============================================================================

=================== APLICA√á√ÉO (PM2) ==========================================

# Ver logs da aplica√ß√£o
sudo -u www-data pm2 logs nova-fire-aquecedores

# Ver logs em tempo real
sudo -u www-data pm2 logs nova-fire-aquecedores --lines 50 -f

# Reiniciar aplica√ß√£o
sudo -u www-data pm2 restart nova-fire-aquecedores

# Parar aplica√ß√£o
sudo -u www-data pm2 stop nova-fire-aquecedores

# Iniciar aplica√ß√£o
sudo -u www-data pm2 start nova-fire-aquecedores

# Ver status de todas as aplica√ß√µes
sudo -u www-data pm2 list

# Ver informa√ß√µes detalhadas
sudo -u www-data pm2 show nova-fire-aquecedores

# Monitor em tempo real
sudo -u www-data pm2 monit

# Reload sem downtime
sudo -u www-data pm2 reload nova-fire-aquecedores

# Ver uso de mem√≥ria e CPU
sudo -u www-data pm2 status

=================== NGINX ===================================================

# Testar configura√ß√£o
sudo nginx -t

# Recarregar configura√ß√£o
sudo systemctl reload nginx

# Reiniciar Nginx
sudo systemctl restart nginx

# Ver status
sudo systemctl status nginx

# Ver logs de acesso
sudo tail -f /var/log/nginx/access.log

# Ver logs de erro
sudo tail -f /var/log/nginx/error.log

# Ver √∫ltimas 100 linhas dos logs
sudo tail -n 100 /var/log/nginx/access.log

=================== SSL/CERTIFICADOS ========================================

# Ver certificados instalados
sudo certbot certificates

# Renovar certificados manualmente
sudo certbot renew

# Testar renova√ß√£o
sudo certbot renew --dry-run

# For√ßar renova√ß√£o
sudo certbot renew --force-renewal

=================== SISTEMA ==================================================

# Ver uso de recursos
htop

# Ver uso de disco
df -h

# Ver processos Node.js
ps aux | grep node

# Ver processos Nginx
ps aux | grep nginx

# Ver portas em uso
sudo netstat -tlnp

# Ver portas espec√≠ficas
sudo netstat -tlnp | grep -E ':(80|443|3001)'

# Ver conex√µes ativas
sudo ss -tuln

=================== ATUALIZA√á√ïES DA APLICA√á√ÉO ===============================

# IMPORTANTE: Resolver problema de "dubious ownership" (se aparecer)
# Se aparecer erro: "fatal: detected dubious ownership in repository"
# Execute PRIMEIRO:
git config --global --add safe.directory /var/www/nova-fire-aquecedores

# Atualizar aplica√ß√£o (quando fizer mudan√ßas no c√≥digo)
cd /var/www/nova-fire-aquecedores
sudo -u www-data git pull origin main
sudo -u www-data npm ci
sudo -u www-data npm run build
sudo -u www-data pm2 reload nova-fire-aquecedores

# Script completo de update (com corre√ß√£o de permiss√£o)
cd /var/www/nova-fire-aquecedores && \
git config --global --add safe.directory /var/www/nova-fire-aquecedores && \
sudo -u www-data git pull origin main && \
sudo -u www-data npm ci && \
sudo -u www-data npm run build && \
sudo -u www-data pm2 reload nova-fire-aquecedores && \
echo "‚úÖ Update conclu√≠do!"

# Alternativa usando sempre www-data para Git:
cd /var/www/nova-fire-aquecedores && \
sudo -u www-data git config --global --add safe.directory /var/www/nova-fire-aquecedores && \
sudo -u www-data git pull origin main && \
sudo -u www-data npm ci && \
sudo -u www-data npm run build && \
sudo -u www-data pm2 reload nova-fire-aquecedores && \
echo "‚úÖ Update conclu√≠do!" \
sudo -u www-data pm2 reload nova-fire-aquecedores && \
echo "‚úÖ Update conclu√≠do!"

===============================================================================
üö® SOLU√á√ÉO DE PROBLEMAS COMUNS
===============================================================================

=================== APLICA√á√ÉO N√ÉO INICIA ====================================

1. Verificar logs:
   sudo -u www-data pm2 logs nova-fire-aquecedores

2. Verificar se a porta est√° livre:
   sudo netstat -tlnp | grep :3001

3. Verificar permiss√µes:
   ls -la /var/www/nova-fire-aquecedores

4. Verificar se o build existe:
   ls -la /var/www/nova-fire-aquecedores/.next/

5. Tentar restart manual:
   cd /var/www/nova-fire-aquecedores
   sudo -u www-data pm2 delete nova-fire-aquecedores
   sudo -u www-data pm2 start ecosystem.config.js

=================== ERRO GIT "DUBIOUS OWNERSHIP" ============================

1. Erro: "fatal: detected dubious ownership in repository"
   git config --global --add safe.directory /var/www/nova-fire-aquecedores

2. Ou configurar para www-data:
   sudo -u www-data git config --global --add safe.directory /var/www/nova-fire-aquecedores

3. Depois tentar pull novamente:
   sudo -u www-data git pull origin main

4. Para evitar no futuro, sempre use www-data para Git:
   sudo -u www-data git pull origin main

=================== NGINX RETORNA ERRO ======================================

1. Testar configura√ß√£o:
   sudo nginx -t

2. Ver logs de erro:
   sudo tail -f /var/log/nginx/error.log

3. Verificar se a aplica√ß√£o est√° rodando:
   curl http://localhost:3001

4. Verificar configura√ß√£o do site:
   sudo nano /etc/nginx/sites-available/nova-fire-aquecedores

5. Recarregar Nginx:
   sudo systemctl reload nginx

=================== SSL N√ÉO FUNCIONA =========================================

1. Verificar DNS:
   nslookup novafireaquecedores.com.br

2. Verificar certificados:
   sudo certbot certificates

3. Tentar obter certificado novamente:
   sudo certbot --nginx -d novafireaquecedores.com.br -d www.novafireaquecedores.com.br

4. Ver logs do Certbot:
   sudo tail -f /var/log/letsencrypt/letsencrypt.log

5. Verificar se as portas 80 e 443 est√£o abertas:
   sudo netstat -tlnp | grep -E ':(80|443)'

=================== SITE MUITO LENTO =========================================

1. Verificar uso de recursos:
   htop

2. Verificar logs da aplica√ß√£o:
   sudo -u www-data pm2 logs nova-fire-aquecedores

3. Reiniciar aplica√ß√£o:
   sudo -u www-data pm2 restart nova-fire-aquecedores

4. Verificar cache do Nginx:
   sudo ls -la /var/cache/nginx/

5. Limpar cache do Nginx:
   sudo rm -rf /var/cache/nginx/*
   sudo systemctl reload nginx

=================== ERRO 502 BAD GATEWAY ====================================

1. Verificar se a aplica√ß√£o est√° rodando:
   sudo -u www-data pm2 list

2. Verificar se a porta 3001 est√° respondendo:
   curl http://localhost:3001

3. Verificar logs do Nginx:
   sudo tail -f /var/log/nginx/error.log

4. Reiniciar aplica√ß√£o:
   sudo -u www-data pm2 restart nova-fire-aquecedores

=================== ERRO 404 NOT FOUND ======================================

1. Verificar se o site est√° habilitado:
   ls -la /etc/nginx/sites-enabled/

2. Verificar configura√ß√£o do servidor:
   sudo nginx -t

3. Verificar DNS:
   nslookup novafireaquecedores.com.br

4. Testar com IP direto:
   curl http://72.60.14.60

=================== DISCO CHEIO ==============================================

1. Verificar uso do disco:
   df -h

2. Limpar logs antigos:
   sudo find /var/log -type f -name "*.log" -mtime +30 -delete

3. Limpar cache:
   sudo rm -rf /var/cache/nginx/*

4. Limpar logs do PM2:
   sudo -u www-data pm2 flush

5. Verificar tamanho dos logs:
   sudo du -sh /var/log/pm2/*

===============================================================================
üìÇ ESTRUTURA DE ARQUIVOS NO SERVIDOR
===============================================================================

/var/www/nova-fire-aquecedores/
‚îú‚îÄ‚îÄ ecosystem.config.js          # Configura√ß√£o do PM2
‚îú‚îÄ‚îÄ package.json                 # Depend√™ncias do projeto
‚îú‚îÄ‚îÄ next.config.ts              # Configura√ß√£o do Next.js
‚îú‚îÄ‚îÄ .next/                      # Build da aplica√ß√£o
‚îú‚îÄ‚îÄ src/                        # C√≥digo fonte
‚îú‚îÄ‚îÄ public/                     # Arquivos p√∫blicos
‚îî‚îÄ‚îÄ node_modules/               # Depend√™ncias instaladas

/etc/nginx/sites-available/nova-fire-aquecedores    # Configura√ß√£o do Nginx
/etc/nginx/sites-enabled/nova-fire-aquecedores      # Link simb√≥lico

/var/log/pm2/                   # Logs da aplica√ß√£o
‚îú‚îÄ‚îÄ nova-fire-aquecedores.log           # Logs gerais
‚îú‚îÄ‚îÄ nova-fire-aquecedores-error.log     # Logs de erro
‚îî‚îÄ‚îÄ nova-fire-aquecedores-out.log       # Logs de sa√≠da

/var/log/nginx/                 # Logs do Nginx
‚îú‚îÄ‚îÄ access.log                  # Logs de acesso
‚îî‚îÄ‚îÄ error.log                   # Logs de erro

/etc/letsencrypt/               # Certificados SSL
‚îî‚îÄ‚îÄ live/novafireaquecedores.com.br/    # Certificados do dom√≠nio

===============================================================================
üìû INFORMA√á√ïES DO PROJETO
===============================================================================

- Nome: Nova Fire Aquecedores
- Reposit√≥rio: https://github.com/DevLucasDaCosta/nova-fire-aquecedores
- Dom√≠nio: https://novafireaquecedores.com.br
- Servidor: 72.60.14.60
- Porta da aplica√ß√£o: 3001
- Tecnologias: Next.js, React, TypeScript, Tailwind CSS
- Servidor web: Nginx
- Gerenciador de processos: PM2
- SSL: Let's Encrypt

===============================================================================
‚úÖ CHECKLIST FINAL
===============================================================================

‚ñ° Node.js 18+ instalado
‚ñ° PM2 instalado e configurado
‚ñ° Nginx instalado e funcionando
‚ñ° Projeto clonado do GitHub
‚ñ° Depend√™ncias instaladas
‚ñ° Build da aplica√ß√£o criado
‚ñ° PM2 executando a aplica√ß√£o
‚ñ° Nginx configurado como proxy reverso
‚ñ° DNS configurado corretamente
‚ñ° SSL configurado com Let's Encrypt
‚ñ° Site acess√≠vel via HTTPS
‚ñ° Renova√ß√£o autom√°tica do SSL configurada

===============================================================================
üéâ PARAB√âNS! SEU SITE EST√Å NO AR!
===============================================================================

Acesse: https://novafireaquecedores.com.br

===============================================================================
